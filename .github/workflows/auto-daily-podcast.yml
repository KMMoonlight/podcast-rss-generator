name: Auto Add Daily Episode & Update RSS

on:
  release:
    types: [published]

jobs:
  update-podcast:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # 必须加这个才能自动 commit
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install yq (for YAML parsing)
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O yq
          chmod +x yq
          sudo mv yq /usr/local/bin/

      - name: Install yamllint (for config validation)
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Validate podcast_config.yaml
        run: yamllint podcast_config.yaml

      - name: Extract info from latest release
        id: release
        run: |
          # 获取最新 release 的 tag 和第一个音频文件（你每次只传一个）
          TAG="${{ github.event.release.tag_name }}"
          FILE=$(jq -r '.assets[0].name' <<< '${{ toJSON(github.event.release.assets) }}')
          
          # 检查文件名是否符合 YYYY-MM-DD.mp3 格式
          if [[ ! $FILE =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})\.mp3$ ]]; then
            echo "文件名必须是 YYYY-MM-DD.mp3 格式，当前文件：$FILE"
            exit 1
          fi
          
          DATE="${BASH_REMATCH[1]}"
          TITLE="$DATE"
          DESCRIPTION="$DATE 新闻"
          ASSET_URL="https://github.com/${{ github.repository }}/releases/download/$TAG/$FILE"
          
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "asset_url=$ASSET_URL" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Calculate next episode number
        id: episode
        run: |
          CURRENT=$(yq '.episodes | length' podcast_config.yaml)
          NEXT=$((CURRENT + 1))
          echo "number=$NEXT" >> $GITHUB_OUTPUT

      - name: Insert new episode at the top of episodes list
        run: |
          yq eval --inplace "
            .episodes = [
              {
                title: \"${{ steps.release.outputs.title }}\",
                description: \"${{ steps.release.outputs.description }}\",
                publication_date: \"${{ steps.release.outputs.date }}T02:30:00Z\",
                asset_url: \"${{ steps.release.outputs.asset_url }}\",
                duration: \"00:05:03\",
                explicit: false,
                season: 1,
                episode: ${{ steps.episode.outputs.number }},
                type: \"full\"
              }
            ] + .episodes
          " podcast_config.yaml

      - name: Commit updated podcast_config.yaml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add podcast_config.yaml
          git commit -m "chore: add daily episode ${{ steps.release.outputs.date }}"
          git push

      - name: Generate RSS Feed
        uses: vpetersson/podcast-rss-generator@master  # ← 关键修复：用 @master
        with:
          input_file: podcast_config.yaml
          output_file: rss.xml

      - name: Ensure output is rss.xml (rename if needed)
        run: |
          if [ -f podcast_feed.xml ]; then
            mv podcast_feed.xml rss.xml
          fi
          ls -la *.xml  # 日志确认文件

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          force_orphan: true

      - name: Done
        run: |
          echo "已自动添加 ${{ steps.release.outputs.date }} 的节目！"
          echo "RSS: https://kmmoonlight.github.io/podcast-rss-generator/rss.xml"
