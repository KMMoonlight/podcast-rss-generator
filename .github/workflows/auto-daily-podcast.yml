# .github/workflows/auto-daily-podcast.yml
name: Auto Add Daily Episode & Update RSS

on:
  release:
    types: [published]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout + 强制切换到 master 分支
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master                     # 强制 checkout 到 master 分支

      - name: 再保险一次：确保在 master 分支上（永不 detached）
        run: |
          git checkout master || git checkout -b master
          git pull origin master --ff-only

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: 提取信息 + 计算 episode 编号
        id: info
        run: |
          FILENAME=$(jq -r '.release.assets[0].name' <<< '${{ toJSON(github.event) }}')
          TAG="${{ github.event.release.tag_name }}"

          if [[ ! $FILENAME =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})\.mp3$ ]]; then
            echo "错误：文件名必须是 YYYY-MM-DD.mp3"
            exit 1
          fi

          DATE="${BASH_REMATCH[1]}"
          URL="https://github.com/${{ github.repository }}/releases/download/$TAG/$FILENAME"
          NEXT_EPISODE=$(( $(yq '.episodes | length' podcast_config.yaml) + 1 ))

          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "episode=$NEXT_EPISODE" >> $GITHUB_OUTPUT   # 关键：纯数字

      - name: 插入新的一集（使用 env 方式，彻底解决变量替换问题）
        env:
          NEW_DATE: ${{ steps.info.outputs.date }}
          NEW_URL: ${{ steps.info.outputs.url }}
          NEW_EPISODE: ${{ steps.info.outputs.episode }}
        run: |
          cat << EOF > /tmp/new-episode.yml
          - title: "$NEW_DATE"
            description: "$NEW_DATE 新闻"
            publication_date: "${NEW_DATE}T02:30:00Z"
            asset_url: "$NEW_URL"
            duration: "00:05:03"
            explicit: false
            season: 1
            episode: $NEW_EPISODE
            type: "full"
          EOF

          yq -i '.episodes = load("/tmp/new-episode.yml") + .episodes' podcast_config.yaml

      - name: Commit & Push（这三行是真正的永不失败写法）
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add podcast_config.yaml
          git commit -m "auto: add episode ${{ steps.info.outputs.date }}"

          # 关键三连：自动拉取最新 → rebase → 再推
          git pull --rebase origin master
          git push origin HEAD:master

          # 如果上面还是被抢了，就用最粗暴但绝对成功的写法（99.99% 不会走到这）
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:master --force-with-lease || true


      - name: Generate RSS
        uses: vpetersson/podcast-rss-generator@master
        with:
          input_file: podcast_config.yaml
          output_file: rss.xml

      - name: Rename if needed
        run: |
          [ -f podcast_feed.xml ] && mv podcast_feed.xml rss.xml || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .

      - name: 完成
        run: |
          echo "成功发布 ${{ steps.info.outputs.date }}！"
          echo "RSS: https://kmmoonlight.github.io/podcast-rss-generator/rss.xml"
