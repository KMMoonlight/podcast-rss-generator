name: Auto Add Daily Episode & Update RSS

on:
  release:
    types: [published]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # 关键权限
    steps:
      - name: Checkout (full history + correct branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # 必须加这一行！否则 git push 找不到 branch

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O yq
          chmod +x yq
          sudo mv yq /usr/local/bin/

      - name: Extract date & URL
        id: info
        run: |
          FILE=$(jq -r '.assets[0].name' <<< '${{ toJSON(github.event.release.assets) }}')
          if [[ ! $FILE =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})\.mp3$ ]]; then
            echo "文件名必须是 YYYY-MM-DD.mp3，当前是：$FILE"
            exit 1
          fi
          DATE="${BASH_REMATCH[1]}"
          TAG="${{ github.event.release.tag_name }}"
          URL="https://github.com/${{ github.repository }}/releases/download/$TAG/$FILE"
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Insert new episode at the very top
        run: |
          yq eval --inplace "
            .episodes |= [
              {
                title: \"$DATE\",
                description: \"$DATE 新闻\",
                publication_date: \"$DATE\T02:30:00Z\",
                asset_url: \"$URL\",
                duration: \"00:05:03\",
                explicit: false,
                season: 1,
                episode: (.episodes | length) + 1,
                type: \"full\"
              }
            ] + .
          " podcast_config.yaml

      - name: Git commit & push updated YAML
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add podcast_config.yaml
          git commit -m "auto: add episode $DATE"
          git push origin HEAD:main   # 强制推到 main

      - name: Generate RSS
        uses: vpetersson/podcast-rss-generator@master
        with:
          input_file: podcast_config.yaml
          output_file: rss.xml

      - name: Ensure rss.xml exists
        run: |
          [ -f podcast_feed.xml ] && mv podcast_feed.xml rss.xml || true
          ls -la rss.xml || echo "rss.xml still missing!"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .

      - name: Done
        run: |
          echo "新的一期 $DATE 已自动添加并发布！"
          echo "RSS → https://kmmoonlight.github.io/podcast-rss-generator/rss.xml"
